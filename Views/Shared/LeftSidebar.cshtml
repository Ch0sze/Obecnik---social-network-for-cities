@model CombinedViewModel
@using System.Web

<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
<link rel="stylesheet" href="~/css/SidebarStyles.css" asp-append-version="true"/>

<div id="leftSidebar" class="sidebar-sb">
    <!-- Logo -->
    <div class="logo-container-sb">
        <img src="~/image.png" alt="Logo">
        <h4>Obecník</h4>
    </div>

    <!-- Dynamic Avatar Container (left sidebar) -->
    <div class="avatar-container-sb" id="user-list-left-sb"></div>

    <!-- Scrollable Navigation (fills remaining height) -->
    <div class="nav-container-sb" id="nav-links-sb">
        <!-- Dynamic content via JS -->
    </div>

    <!-- Profile Info -->
    <div class="profile-container-sb">
        <div class="profile-header-sb">
            <button class="icon-btn-sb" id="user-profile-btn-sb2">
                <i class="bi bi-person"></i>
            </button>
            <span class="text-sb" id="username-sb2">@User.Identity?.Name</span>
            <button class="icon-btn-sb" id="hamburger-menu-btn-sb2">
                <i class="bi bi-box-arrow-right"></i>
            </button>
        </div>

        <!-- Dropdown -->
        <div id="dropdown-menu-sb" class="dropdown-menu-sb" style="display: none;">
            <button class="dropdown-item-sb" id="logout-btn-sb">Odhlásit se</button>
        </div>
    </div>

    <!-- Popup Form -->
    <div id="admin-request-popup" class="popup-sb" style="display: none;">
        <div class="popup-content-sb">
            <h3>Žádost o práva správce</h3>

            <form id="admin-request-form" method="post" action="/adminrequest">
                <div class="form-group-sb">
                    <label for="community-name">Název komunity</label>
                    <!-- Check if AdminRequestViewModel is not null -->
                    <input type="text" id="community-name" name="communityName" readonly value="@Model.AdminRequestViewModel?.FirstOrDefault()?.Community?.Name">
                </div>

                <input type="hidden" id="community-id" name="communityId"
                       value="@Model.AdminRequestViewModel?.FirstOrDefault()?.Community?.Id"/>

                <div class="form-group-sb">
                    <label for="official-input">Oficiální email</label>
                    <!-- Check if AdminRequestViewModel is not null -->
                    <input type="text" id="official-input" name="officialEmail" placeholder="Oficiální email obce, starosty, či jiného pověřeného orgánu..." value="@Model.AdminRequestViewModel?.FirstOrDefault()?.OfficialEmail">
                </div>

                <div class="form-group-sb">
                    <label for="notes">Poznámky</label>
                    <!-- Check if AdminRequestViewModel is not null -->
                    <textarea id="notes" name="notes" rows="5" placeholder="Zadejte doplňující informace...">@Model.AdminRequestViewModel?.FirstOrDefault()?.Notes</textarea>
                </div>

                <div class="form-group-sb">
                    <button class="btn-sb" type="submit">Odeslat žádost</button>
                </div>
            </form>

            <button class="close-btn-sb" onclick="closePopup()">X</button>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        let navItems = [
            { icon: '', label: 'Obecné', link: '/#', active: false, dot: true }
        ];

        let users = [
            {
                name: '@Html.Raw(HttpUtility.JavaScriptStringEncode(Model.HomeViewModel?.CommunityName))',
                image: '/community/image/' + '@Model.HomeViewModel!.CommunityId',
                dot: true,
                link: "/#",
                communityId: '@Model.HomeViewModel!.CommunityId'
            }
        ];

        function renderLeftAvatars() {
            const userList = document.getElementById('user-list-left-sb');
            userList.innerHTML = '';

            users.forEach((user, index) => {
                const item = document.createElement('div');
                item.className = 'user-item-sb';

                item.innerHTML = `
                    <div style="display: flex; align-items: center; justify-content: space-between; width: 100%;">
                        <div style="display: flex; align-items: center;">
                            <button class="avatar-btn-sb" onclick="onAvatarClick(${index})" style="margin-right: 8px;">
                                <img src="${user.image}" alt="${user.name}">
                            </button>
                            <div style="display: flex; flex-direction: column;">
                                <span class="text-sb" style="font-size: 0.95rem;">${user.name}</span>
                                <button
                                    onclick="requestAdminRights(${index})"
                                    style="background: none; border: none; color: #007bff; font-size: 0.75rem; padding: 0; margin-top: 2px; cursor: pointer; text-align: left; display: flex; align-items: center;">
                                    <i class="material-icons" style="font-size: 16px; margin-right: 4px;">person_add</i>
                                    Žádost o správce
                                </button>
                            </div>
                        </div>
                        ${user.dot ? `<span class="dot-sb ms-auto"></span>` : ''}
                    </div>
                `;
                userList.appendChild(item);
            });
        }

        function renderNav() {
            const navContainer = document.getElementById('nav-links-sb');
            navContainer.innerHTML = '';

            navItems.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = `nav-item-sb${item.active ? ' active-sb' : ''}`;
                div.dataset.index = index;

                div.innerHTML = ` 
                    <a href="${item.link}" onclick="updateDot(${index})">
                        ${item.icon ? `<span class="material-icons me-3">${item.icon}</span>` : '<span class="material-icons me-3" style="opacity: 0;">place</span>'}
                        <span class="text-sb">${item.label}</span>
                        ${item.dot ? `<span class="dot-sb ms-auto"></span>` : ''}
                    </a>
                `;

                navContainer.appendChild(div);
            });
        }

        renderLeftAvatars();
        renderNav();

        window.requestAdminRights = function (index) {
            const user = users[index];
            document.getElementById('community-name').value = user.name;
            document.getElementById('community-id').value = user.communityId;
            document.getElementById('admin-request-popup').style.display = 'flex';
        };

        window.closePopup = function () {
            document.getElementById('admin-request-popup').style.display = 'none';
        };
    });
</script>

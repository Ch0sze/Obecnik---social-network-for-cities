@model RegisterViewModel
@{
    ViewData["Title"] = "Registrace";
}

<div class="container">
    <div class="row align-items-center justify-content-center" style="min-height: 100vh;">
        <div class="col-12 col-md-8 col-lg-6">
            <!-- Logo and label -->
            <div class="header-section text-center mb-4 mt-4">
                <!-- For the logo image (desktop) -->
                <a href="/Landing" class="d-none d-sm-block">
                    <img src="~/image.png"
                         class="img-fluid"
                         style="height:100px; width:auto;"
                         alt="Logo">
                </a>
                
                <!-- For the OBECNÍK text -->
                <a href="/Landing" style="text-decoration: none; color: inherit;">
                    <h2 class="m-0">OBECNÍK</h2>
                </a>
            </div>

            <!-- Form container -->
            <div class="register-container p-4 w-100 mx-auto">
                <form asp-controller="Account" asp-action="RegisterSubmit" method="post" novalidate id="register-form">
                    <!-- Email -->
                    <div class="mb-3">
                        <label asp-for="Email" class="login-label" style="font-weight: bold; color: black;">Email:</label>
                        <input asp-for="Email"
                               class="form-control register-input @ViewData.ValidationClass(model => model.Email)"
                               placeholder="Email" style="background-color: #FAFAFA !important; 
                               border: none !important; border-bottom: 1px solid #F98866 !important; border-radius: 0 !important;
                               box-shadow: none !important; outline: none !important;"/>
                        <span asp-validation-for="Email" class="invalid-feedback"></span>
                    </div>

                    <!-- Password -->
                    <div class="mb-3">
                        <label asp-for="Password" class="register-label" style="font-weight: bold; color: black;">Heslo:</label>
                        <input asp-for="Password" type="password"
                               class="form-control register-input @ViewData.ValidationClass(model => model.Password)"
                               placeholder="********" style="background-color: #FAFAFA !important; 
                               border: none !important; border-bottom: 1px solid #F98866 !important; border-radius: 0 !important;
                               box-shadow: none !important; outline: none !important;"/>
                        <small class="form-text text-muted" style="color: gray;">Heslo musí obsahovat alespoň jedno velké písmeno a číslo</small>
                        <span asp-validation-for="Password" class="invalid-feedback"></span>
                    </div>

                    <!-- Repeat Password -->
                    <div class="mb-3">
                        <label asp-for="PasswordRepeat" class="register-label" style="font-weight: bold; color: black;">Opakovat heslo:</label>
                        <input asp-for="PasswordRepeat" type="password"
                               class="form-control register-input @ViewData.ValidationClass(model => model.PasswordRepeat)"
                               placeholder="********" style="background-color: #FAFAFA !important; 
                               border: none !important; border-bottom: 1px solid #F98866 !important; border-radius: 0 !important;
                               box-shadow: none !important; outline: none !important;"/>
                        <span asp-validation-for="PasswordRepeat" class="invalid-feedback"></span>
                    </div>

                    <!-- First Name -->
                    <div class="mb-3">
                        <label asp-for="FirstName" class="register-label" style="font-weight: bold; color: black;">Jméno:</label>
                        <input asp-for="FirstName"
                               class="form-control register-input @ViewData.ValidationClass(model => model.FirstName)"
                               placeholder="Jméno" style="background-color: #FAFAFA !important; 
                               border: none !important; border-bottom: 1px solid #F98866 !important; border-radius: 0 !important;
                               box-shadow: none !important; outline: none !important;"/>
                        <span asp-validation-for="FirstName" class="invalid-feedback"></span>
                    </div>

                    <!-- Surname -->
                    <div class="mb-3">
                        <label asp-for="LastName" class="register-label" style="font-weight: bold; color: black;">Příjmení:</label>
                        <input asp-for="LastName"
                               class="register-input form-control @ViewData.ValidationClass(model => model.LastName)"
                               placeholder="Příjmení" style="background-color: #FAFAFA !important; 
                               border: none !important; border-bottom: 1px solid #F98866 !important; border-radius: 0 !important;
                               box-shadow: none !important; outline: none !important;"/>
                        <span asp-validation-for="LastName" class="invalid-feedback"></span>
                    </div>

                    <!-- Address -->
                    <div class="mb-3" style="position: relative;">
                        <label asp-for="Residence" class="register-label" style="font-weight: bold; color: black;">Lokalita:</label>

                        <!-- Readonly Input (Shows Selected Address) -->
                        <input type="text"
                               id="readonlyInput"
                               class="register-input form-control"
                               placeholder="Vyberte adresu a PSČ"
                               readonly
                               value=""
                               style="background-color: #FAFAFA !important;
                  border: none !important; border-bottom: 1px solid #F98866 !important; border-radius: 0 !important;
                  box-shadow: none !important; outline: none !important; cursor: pointer;" />

                        <!-- Hidden Search Input -->
                        <input type="text"
                               id="searchInput"
                               class="register-input form-control @ViewData.ValidationClass(model => model.Residence)"
                               placeholder="Zadejte adresu nebo PSČ"
                               style="display: none; background-color: #FAFAFA !important;
                  border: none !important; border-bottom: 1px solid #F98866 !important; border-radius: 0 !important;
                  box-shadow: none !important; outline: none !important;" />

                        <!-- Hidden Fields to Store Residence and Postal Code -->
                        <input type="hidden" asp-for="Residence" id="residenceField"/>
                        <input type="hidden" asp-for="PostalCode" id="postalcodeField">

                        <!-- Suggestions Box -->
                        <ul id="suggestions" class="list-group" style="position: absolute; width: 100%; z-index: 10;"></ul>
                        <p class="form-text text-muted" style="color: gray;">Pokud nemůžete najít svou adresu, zkuste zadat PSČ</p>
                        <span asp-validation-for="Residence" class="invalid-feedback"></span>
                        <span asp-validation-for="PostalCode" class="invalid-feedback"></span>
                    </div>



                    <!-- Checkbox for terms -->
                    <div class="form-check mb-3">
                        <input type="checkbox" id="terms" name="terms" class="form-check-input" />
                        <label for="terms" class="form-check-label text-dark fw-bold">
                            Souhlasím s
                            <a href="#" id="terms-link" style="text-decoration: underline;">podmínkami užití</a>
                        </label>
                    </div>


                    <div id="terms-error" class="text-danger mb-3">
                        Musíte souhlasit s podmínkami užití pro registraci
                    </div>

                    <!-- Registration button -->
                    <div class="text-center">
                        <button type="submit" class="register-button" id="submit-button" disabled>
                            Registrace
                        </button>
                    </div>
                </form>

                @if (!string.IsNullOrWhiteSpace(Model.Message))
                {
                    <div class="alert alert-danger mt-4 text-center" role="alert">
                        @Model.Message
                    </div>
                }
            </div>
            <div class="mt-4 register-link text-center" style="margin-bottom: 50px">
                Máte účet?
                <a href="/Account/Login">Přihlašte se zde</a>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        setFormattedAddress(residence, postalCode);
    });

    function formatPostalCode(postalCode) {
        if (!postalCode) return '';
        postalCode = postalCode.toString().replace(/\s+/g, '');
        return postalCode.slice(0, 3) + ' ' + postalCode.slice(3);
    }

    function setFormattedAddress(residence, postalCode) {
        const input = document.getElementById('readonlyInput');
        if (!input) return;

        let formatted = '';
        if (residence) {
            formatted += residence;
        }
        if (postalCode) {
            formatted += residence ? `, ${formatPostalCode(postalCode)}` : formatPostalCode(postalCode);
        }

        input.value = formatted;
    }


    document.addEventListener('DOMContentLoaded', function () {
        const residence = @Html.Raw(Json.Serialize(Model.Residence ?? ""));
        const postalCode = @Html.Raw(Json.Serialize(Model.PostalCode ?? ""));
        setFormattedAddress(residence, postalCode);
    });
    document.addEventListener('DOMContentLoaded', function () {
        const residence = document.getElementById("residenceField").value;
        const postalCode = document.getElementById("postalcodeField").value;

        setFormattedAddress(residence, postalCode);
    });


    document.addEventListener("DOMContentLoaded", function () {
        const termsLink = document.getElementById("terms-link");
        const termsCheckbox = document.getElementById("terms");
        const termsError = document.getElementById("terms-error");
        const submitButton = document.getElementById("submit-button");

        // Popup window terms (create popup element dynamically)
        const popup = document.createElement("div");
        popup.style.display = "none";
        popup.style.position = "fixed";
        popup.style.top = "0";
        popup.style.left = "0";
        popup.style.width = "100%";
        popup.style.height = "100%";
        popup.style.backgroundColor = "rgba(0, 0, 0, 0.5)";
        popup.style.zIndex = "9999";
        popup.style.overflow = "overlay";

        // Popup content
        const popupContent = document.createElement("div");
        popupContent.classList.add("popup-content");
        popupContent.style.position = "relative";
        popupContent.style.margin = "7% auto";
        popupContent.style.padding = "30px";
        popupContent.style.backgroundColor = "white";
        popupContent.style.borderRadius = "8px";
        popupContent.style.boxShadow = "0px 4px 8px rgba(0, 0, 0, 0.2)";
        popupContent.style.maxWidth = "50%";
        popupContent.style.maxHeight = "75%";
        popupContent.style.overflowY = "auto";
        popupContent.style.lineHeight = "1.6";

        // Add terms content to the popup
        popupContent.innerHTML = `
    <span class="popup-close" style="cursor: pointer; position: absolute; top: 15px; right: 15px; font-size: 22px;">&times;</span>
    <h2 style="margin-bottom: 10px;">Podmínky užití</h2>
    <p><strong>1. Úvodní ustanovení</strong></p>
    <p>1.1. Tyto podmínky užití (dále jen "Podmínky") upravují pravidla používání webové aplikace Obecník, která umožňuje uživatelům účastnit se komunitních aktivit v obcích a komunikovat s ostatními uživateli.</p>
    <p>1.2. Používáním aplikace souhlasíte s těmito Podmínkami a potvrzujete, že jste je přečetli a rozumíte jim. Pokud s nimi nesouhlasíte, nemůžete aplikaci používat.</p>
    <p><strong>2. Registrace a uživatelský účet</strong></p>
    <p>2.1. Pro používání některých funkcí aplikace je nutné se zaregistrovat. Při registraci musí uživatel poskytnout správné a aktuální údaje.</p>
    <p>2.2. Uživatelé jsou povinni chránit své přihlašovací údaje a zodpovídají za všechny aktivity provedené prostřednictvím jejich účtu.</p>
    <p><strong>3. Práva a povinnosti uživatelů</strong></p>
    <p>3.1. Uživatelé se zavazují používat aplikaci v souladu s platnými právními předpisy a těmito Podmínkami.</p>
    <p>3.2. Uživatelé nesmí:</p>
    <ul>
        <li>Publikovat obsah, který je urážlivý, diskriminační, nezákonný nebo porušuje práva jiných osob.</li>
        <li>Šířit nevyžádané zprávy, spam nebo reklamu.</li>
        <li>Poškozovat funkčnost aplikace nebo jinak ohrožovat její bezpečnost.</li>
    </ul>
    <p>3.3. Uživatelé souhlasí s tím, že obsah, který zveřejní v aplikaci, může být veřejně přístupný a může být sdílen s ostatními uživateli.</p>
    <p><strong>4. Obsah a moderování</strong></p>
    <p>4.1. Uživatelé jsou zodpovědní za obsah, který zveřejní, a za jakékoliv následky jeho zveřejnění.</p>
    <p>4.2. Aplikace si vyhrazuje právo upravit nebo odstranit obsah, který porušuje tyto Podmínky.</p>
    <p>4.3. Administrátoři mají právo moderovat obsah, mazat příspěvky a přijímat opatření proti uživatelům, kteří porušují pravidla aplikace.</p>
    <p><strong>5. Ochrana osobních údajů</strong></p>
    <p>5.1. Vaše osobní údaje jsou shromažďovány a zpracovávány v souladu s platnými zákony o ochraně osobních údajů.</p>
    <p>5.2. Uživatelé mají právo přistupovat k těmto údajům, opravovat je nebo požadovat jejich odstranění.</p>
    <p><strong>6. Změny podmínek</strong></p>
    <p>6.1. Aplikace si vyhrazuje právo kdykoliv změnit tyto Podmínky. Změny budou zveřejněny v aplikaci a budou platné okamžitě po jejich zveřejnění.</p>
    <p><strong>7. Závěrečná ustanovení</strong></p>
    <p>7.1. Tyto Podmínky představují celkovou dohodu mezi uživatelem a aplikací.</p>
    <p>7.2. Jakékoliv spory vzniklé v souvislosti s těmito Podmínkami budou řešeny v souladu s právním řádem České republiky.</p>
    `;

        popup.appendChild(popupContent);
        document.body.appendChild(popup);

        // Open popup on clicking the terms link
        termsLink.addEventListener("click", function (event) {
            event.preventDefault();
            popup.style.display = "block";
        });

        // Close popup when clicking on X
        const closePopup = popup.querySelector(".popup-close");
        closePopup.addEventListener("click", function () {
            popup.style.display = "none";
        });

        // Close popup when clicking outside the content area
        window.addEventListener("click", function(event) {
            if (event.target === popup) {
                popup.style.display = "none";
            }
        });

        // Handle checkbox behavior
        if (!termsCheckbox.checked) {
            termsError.classList.remove("d-none");
        }

        // Toggle error message and submit button status based on checkbox
        termsCheckbox.addEventListener("change", function () {
            if (termsCheckbox.checked) {
                termsError.classList.add("d-none");
                submitButton.disabled = false;
            } else {
                termsError.classList.remove("d-none");
                submitButton.disabled = true;
            }
        });

        // Prevent form submission if checkbox is unchecked
        document.getElementById("register-form").addEventListener("submit", function (event) {
            if (!termsCheckbox.checked) {
                event.preventDefault();
                termsError.classList.remove("d-none");
            }
        });
        
        // Add style for thumb like scrollbar
        const style = document.createElement('style');
        style.innerHTML = `
            *::-webkit-scrollbar {
              background-color: transparent;
              width: 12px;
            }
            *::-webkit-scrollbar-track {
              background-color: transparent;
            }
            *::-webkit-scrollbar-thumb {
              border-radius: 20px;
              border: 3px solid transparent;
              background-color: rgba(0,0,0,0.3);
              background-clip: content-box;
            }    
            `;
        document.head.appendChild(style);
    });

    document.addEventListener("DOMContentLoaded", function () {
        const termsCheckbox = document.getElementById("terms");
        const termsError = document.getElementById("terms-error");
        const submitButton = document.getElementById("submit-button");

        // Initially show the error message if checkbox is not checked
        if (!termsCheckbox.checked) {
            termsError.classList.remove("d-none");
        }

        // Toggle error message visibility based on checkbox
        termsCheckbox.addEventListener("change", function () {
            if (termsCheckbox.checked) {
                termsError.classList.add("d-none");
                submitButton.disabled = false;
            } else {
                termsError.classList.remove("d-none");
                submitButton.disabled = true;
            }
        });

        // When submitting the form, check if checkbox is checked and show/hide error accordingly
        document.getElementById("register-form").addEventListener("submit", function (event) {
            if (!termsCheckbox.checked) {
                event.preventDefault();
                termsError.classList.remove("d-none");
            }
        });
    });
    document.addEventListener("DOMContentLoaded", function () {
        const readonlyInput = document.getElementById("readonlyInput");
        const searchInput = document.getElementById("searchInput");
        const suggestionsBox = document.getElementById("suggestions");

        const residenceField = document.getElementById("residenceField");
        const postalcodeField = document.getElementById("postalcodeField");

        let timeout = null;

        // Click on readonly input to switch to search input
        readonlyInput.addEventListener("click", function () {
            readonlyInput.style.display = "none";  // Hide readonly input
            searchInput.style.display = "block";   // Show search input
            searchInput.focus();
        });

        // Handle input in search box
        searchInput.addEventListener("input", function () {
            clearTimeout(timeout);
            timeout = setTimeout(() => {
                searchCityPostcode();
            }, 300);
        });

        async function searchCityPostcode() {
            const query = searchInput.value.trim();
            if (query.length < 2) {
                suggestionsBox.style.display = "none";
                return;
            }

            const apiKey = "ulZ6yvSAHSr1Nc-_aHfZUMclfryM1ZDKLUgOaU8dUgw";
            const url = `https://api.mapy.cz/v1/suggest?lang=cs&apikey=${apiKey}&query=${encodeURIComponent(query)}&limit=10&type=regional.address&countryCode=CZ&locality=CZ`;

            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error("Chyba při načítání API");
                const data = await response.json();

                const seen = new Set();
                suggestionsBox.innerHTML = "";

                if (data.items && data.items.length > 0) {
                    data.items.forEach(item => {
                        const city = item.location.split(",")[0].trim(); // Extract city
                        const zip = item.zip || ""; // Extract postal code
                        const suggestionText = `${city}, ${zip}`.trim();

                        if (!seen.has(suggestionText)) {
                            seen.add(suggestionText);

                            const listItem = document.createElement("li");
                            listItem.classList.add("list-group-item", "list-group-item-action");
                            listItem.textContent = suggestionText;
                            listItem.style.cursor = "pointer";

                            listItem.addEventListener("click", function () {
                                readonlyInput.value = suggestionText; // Show in readonly field
                                residenceField.value = city;  // Store residence in hidden field
                                postalcodeField.value = zip.replace(/\s/g, ""); // Remove spaces from postal code

                                console.log("Residence set to:", residenceField.value);
                                console.log("PostalCode set to:", postalcodeField.value); // Debugging

                                searchInput.value = "";
                                searchInput.style.display = "none";
                                readonlyInput.style.display = "block";
                                suggestionsBox.style.display = "none";
                            });


                            suggestionsBox.appendChild(listItem);
                        }
                    });

                    suggestionsBox.style.width = `${searchInput.offsetWidth}px`;
                    suggestionsBox.style.display = "block";
                } else {
                    suggestionsBox.style.display = "none";
                }
            } catch (error) {
                console.error("API Error:", error);
                suggestionsBox.style.display = "none";
            }
        }

        // Click outside to close search
        document.addEventListener("click", function (event) {
            if (!readonlyInput.contains(event.target) &&
                !searchInput.contains(event.target) &&
                !suggestionsBox.contains(event.target)) {
                suggestionsBox.style.display = "none";
                searchInput.style.display = "none";
                readonlyInput.style.display = "block";
            }
        });
    });





</script>
